setenv -g PATH "/opt/homebrew/bin:/bin:/usr/bin"
setenv -g TMUX_PLUGIN_MANAGER_PATH '$~/.config/tmux/plugins/'

# ===========================================
# General
# ===========================================
set-option -g extended-keys on
set-option -gw mode-keys vi
set-option -sg escape-time 0
set-option -g mouse on

set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g focus-events on
set -s set-clipboard on

# ===========================================
# Terminal
# ===========================================
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -sa terminal-features ",xterm-ghostty:RGB"

# ===========================================
# Styles
# ===========================================

# Tokyo Night Colors
%hidden TN_BG="#1a1b26"
%hidden TN_FG="#c0caf5"
%hidden TN_BLUE="#7aa2f7"
%hidden TN_CYAN="#7dcfff"
%hidden TN_GREEN="#9ece6a"
%hidden TN_YELLOW="#e0af68"
%hidden TN_RED="#f7768e"
%hidden TN_MAGENTA="#bb9af7"
%hidden TN_COMMENT="#565f89"

# Pane Border
set -g pane-border-style "fg=#{TN_COMMENT}"
set -g pane-active-border-style "fg=#{TN_BLUE}"

# ===========================================
# Status Bar
# ===========================================
set -g status on
set -g status-interval 5
set -g status-position top
set -g status-justify left
set -g status-style "bg=default,fg=#{TN_FG}"

# Left: session name (yellow on prefix, [COPY] on copy-mode)
set -g status-left-length 40
set -g status-left "#{?client_prefix,#[fg=#{TN_BG}]#[bg=#{TN_YELLOW}],#[fg=#{TN_BG}]#[bg=#{TN_BLUE}]}#{?pane_in_mode,#[bg=#{TN_MAGENTA}] [COPY] , ❐ #S }#[default]"

# Right: repo name + gitmux
set -g status-right-length 100
set -g status-right "#[fg=#{TN_CYAN}] #(cd \"#{pane_current_path}\" && basename \"$(git rev-parse --show-toplevel 2>/dev/null)\" 2>/dev/null) #[default]#(gitmux -cfg ~/.config/gitmux/gitmux.conf \"#{pane_current_path}\")"

# Window Tab Style
set -g window-status-format "#[fg=#{TN_COMMENT}]  #I:#W  "
set -g window-status-current-format "#[fg=#{TN_BLUE},bold]  #I:#W  "
set -g window-status-separator ""

# Copy Mode Style
set -g mode-style "bg=#{TN_BLUE},fg=#{TN_BG}"

# Message Style
set -g message-style "bg=#{TN_BLUE},fg=#{TN_BG}"
set -g message-command-style "bg=#{TN_YELLOW},fg=#{TN_BG}"

# ===========================================
# Session Management (tm integration)
# ===========================================
bind-key "T" display-popup -E -w 60% -h 60% "\
  session=\$(tmux list-sessions -F '#{session_name}' | fzf --reverse --border-label ' sessions '); \
  [[ -n \"\$session\" ]] && tmux switch-client -t \"\$session\""

bind-key "R" display-popup -E -w 70% -h 70% "\
  repo=\$(ghq list | fzf --reverse --border-label ' repositories '); \
  if [[ -n \"\$repo\" ]]; then \
    dir=\"\$(ghq root)/\$repo\"; \
    name=\"\$(basename \"\$repo\")\"; \
    tmux list-sessions -F '#{session_name}' 2>/dev/null | grep -qE \"^\${name}\$\" || \
      tmux new-session -d -c \"\$dir\" -s \"\$name\"; \
    tmux switch-client -t \"\$name\"; \
  fi"

bind-key "W" display-popup -E -w 70% -h 70% "\
  selected=\$(git worktree list 2>/dev/null | fzf --reverse --border-label ' worktrees '); \
  if [[ -n \"\$selected\" ]]; then \
    dir=\"\$(echo \"\$selected\" | awk '{print \$1}')\"; \
    name=\"\$(basename \"\$dir\")\"; \
    tmux list-sessions -F '#{session_name}' 2>/dev/null | grep -qE \"^\${name}\$\" || \
      tmux new-session -d -c \"\$dir\" -s \"\$name\"; \
    tmux switch-client -t \"\$name\"; \
  fi"

# ===========================================
# Popup Workflows
# ===========================================
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "lazygit"
bind b display-popup -E -w 80% -h 80% "btop"
bind ` display-popup -E "tmux attach -t scratch || tmux new -s scratch"
# ===========================================
# Keybindings
# ===========================================
unbind C-b
set -g prefix C-g
bind C-g send-prefix

# Pane navigation (Vim like)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Copy Mode (Vim like)
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Reload config
bind r source-file ~/.config/tmux/tmux.conf \; display "Reloaded tmux.conf"

# Kill server
bind Q kill-server

# ===========================================
# Plugins (TPM)
# ===========================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-save-interval '10'
set -g @continuum-restore 'on'

# Automatic TPM installation (if not exits)
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

run '~/.config/tmux/plugins/tpm/tpm'
